#!/usr/bin/env bash
# Execute MRTG to build a history
# Create the container:
#      lxc launch images:ubuntu/focal/amd64 mrtg-v1

MRTG_DIR="/usr/mrtg-1.0"
OUTPUT_DIR="$MRTG_DIR/output"
CONTAINER_NAME="mrtg-v1"

# Clean the output directory from the last run
lxc exec $CONTAINER_NAME -- rm -rf $OUTPUT_DIR/*
rm -rf ~/Desktop/mrtg/*

current_epoch=$(date '+%s')

# Go through a time machine running mrtg every five minutes
for i in $(seq --separator=' ' 100)
do
    lxc exec $CONTAINER_NAME -- \
        faketime "$(date -d @$current_epoch +'%Y-%m-%d %H:%M:%S')" bash -c \
            "$MRTG_DIR/mrtg $MRTG_DIR/mrtg.cfg"
     printf '.'
     current_epoch=$((current_epoch+300))
done

#lxc exec $CONTAINER_NAME -- \
#    faketime "$(date -d @$current_epoch +'%Y-%m-%d %H:%M:%S')" bash -c \
#        "for ((i=0; i<10; i=i+1)) do $MRTG_DIR/mrtg $MRTG_DIR/mrtg.cfg; printf '.'; current_epoch=$((current_epoch+300)); done"

# Download the output to the host
lxc file pull --recursive $CONTAINER_NAME$OUTPUT_DIR ~/Desktop/mrtg
